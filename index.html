<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Simulateur de valeur d’occasion - TECHPRECISION</title>
  <link rel="icon" type="image/png" href="logo.png" />
  <style>
    :root{
      --bg:#0a0d12; --card:#111418ee; --muted:#a1b5b5; --text:#e6f2f0;
      --accent:#9ae66e; --accent2:#6cd0d9; --ok:#7ee2a8; --bad:#f57c7c;
      --shadow:0 10px 25px rgba(0,0,0,.35); --radius:18px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:linear-gradient(180deg,#0a0d12,#111418);color:var(--text)}
    .wrap{max-width:1100px;margin:40px auto;padding:20px}
    header{display:flex;flex-direction:column;align-items:center;text-align:center;margin-bottom:32px;position: relative;}
    .brand{display:flex;align-items:center;gap:16px}
    .brand img{width:64px;height:64px;object-fit:contain;border-radius:999px;background:radial-gradient(ellipse at 30% 30%, rgba(154,230,110,.15), rgba(108,208,217,.1));padding:8px;border:1px solid rgba(255,255,255,.06)}
    .brand-text {text-align: left;}
    .brand-text h2 {margin:0;font-size: clamp(24px, 4vw, 38px);font-weight: 800;letter-spacing: .5px;color: var(--text);}
    h1{font-size:clamp(16px, 2.5vw, 22px);margin:0;line-height:1.2;background:linear-gradient(90deg,var(--accent),var(--accent2));-webkit-background-clip:text;-webkit-text-fill-color:transparent;font-weight: 600;}
    .badge{font-size:12px;color:#0b1226;background:linear-gradient(90deg,var(--accent),var(--accent2));padding:6px 10px;border-radius:999px;font-weight:700;letter-spacing:.3px;position: absolute;top: 0;right: 0;}
    .grid{display:grid;grid-template-columns:1.2fr .8fr;gap:20px}
    @media (max-width:960px){.grid{grid-template-columns:1fr}}
    .card{background:var(--card);border:1px solid rgba(255,255,255,.06);border-radius:var(--radius);box-shadow:var(--shadow)}
    .card h2{margin:0 0 6px 0;font-size:18px;color:var(--accent2)}
    .card .sub{color:var(--muted);font-size:13px;margin-bottom:14px}
    .card .body{padding:18px}
    .step{display:flex;gap:12px;align-items:center;margin:16px 0 10px}
    .step .num{width:28px;height:28px;border-radius:999px;display:grid;place-items:center;background:#0b1020;border:1px solid rgba(255,255,255,.08);background:linear-gradient(135deg,var(--accent),var(--accent2));color:#0a0d12;font-weight:700}
    label{display:block;font-size:13px;color:var(--muted);margin:14px 0 6px}
    select,input[type="text"],input[type="number"],input[type="date"],textarea,.pillset{width:100%;background:#0d1117;border:1px solid rgba(255,255,255,.1);color:var(--text);padding:12px 12px;border-radius:12px;outline:none; transition: border-color .2s, box-shadow .2s; font-family: inherit;}
    select:focus,input:focus,textarea:focus{border-color:var(--accent2);box-shadow:0 0 0 3px rgba(108,208,217,.2)}
    input.is-invalid {border-color: var(--bad);box-shadow: 0 0 0 3px rgba(245, 124, 124, 0.2);}
    textarea{resize:vertical; min-height: 80px;}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:720px){.row{grid-template-columns:1fr}}
    .pillset{display:flex;gap:8px;flex-wrap:wrap;padding:8px}
    .pill{padding:8px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.1);cursor:pointer;font-size:13px;user-select:none}
    .pill[data-active="true"]{border-color:var(--accent2);box-shadow:0 0 0 2px rgba(108,208,217,.25) inset}
    .result{padding:20px;border-top:1px dashed rgba(255,255,255,.1); transition: opacity .3s, filter .3s;}
    .result.is-disabled {opacity: 0.5;filter: blur(2px);pointer-events: none;}
    .price{font-size:34px;font-weight:800;color:var(--accent)}
    .price small{font-size:14px;color:var(--muted);font-weight:600}
    .delta{color:var(--muted);font-size:13px;margin-top:6px; min-height: 18px;}
    .cta{display:flex;gap:10px;margin-top:16px;flex-wrap:wrap}
    .btn{background:linear-gradient(90deg,var(--accent),var(--accent2));color:#061019;font-weight:800;border:none;border-radius:12px;padding:12px 16px;cursor:pointer; transition: opacity .2s;}
    .btn:disabled{cursor:not-allowed;opacity:.5}
    .btn.secondary{background:#131a33;color:#e6f2f0;border:1px solid rgba(255,255,255,.08)}
    .tag{display:inline-block;padding:4px 8px;border-radius:999px;background:#0c1328;border:1px solid rgba(255,255,255,.08);font-size:12px;color:var(--muted);margin-right:6px}
    .muted{color:var(--muted)}
    .note{font-size:12px;color:var(--muted);margin-top:8px}
    footer{opacity:.8;text-align:center;font-size:12px;margin:24px 0}
    .btnLink{display:inline-block;margin-top:8px;background:linear-gradient(90deg,var(--accent),var(--accent2));color:#061019;padding:8px 12px;border-radius:8px;font-weight:700;text-decoration:none}
    .tests{margin-top:10px;font-size:12px;color:var(--muted)}
    #maintenanceSection {padding: 10px 0;}
    /* AMÉLIORATION : Styles pour la modale personnalisée */
    .modal-overlay {
      display: none; position: fixed; z-index: 1000; left: 0; top: 0;
      width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.7);
      backdrop-filter: blur(5px);
    }
    .modal-content {
      background-color: var(--card); margin: 15% auto; padding: 24px;
      border: 1px solid rgba(255,255,255,.1); width: 90%; max-width: 500px;
      border-radius: var(--radius); text-align: center; position: relative;
      animation: fadeIn .3s ease-out;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: scale(.95); }
      to { opacity: 1; transform: scale(1); }
    }
    .modal-close {
      position: absolute; top: 10px; right: 20px; color: var(--muted);
      font-size: 28px; font-weight: bold; cursor: pointer; transition: color .2s;
    }
    .modal-close:hover, .modal-close:focus { color: var(--text); }
    .modal-content h3 { color: var(--accent2); margin-top: 0; font-size: 20px; }
    .modal-content p { color: var(--text); font-size: 15px; line-height: 1.5; margin-bottom: 20px; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <img src="logo.png" alt="Logo TECHPRECISION" />
        <div class="brand-text">
            <h2>TECHPRECISION972</h2>
            <h1>Simulateur de valeur d’occasion</h1>
        </div>
      </div>
      <span class="badge">BETA</span>
    </header>

    <div class="grid">
      <!-- LEFT: form -->
      <section class="card" id="formCard">
        <div class="body">
          <div class="step"><span class="num">1</span><h2>Type d’équipement</h2></div>
          <div class="row">
            <div>
              <label for="deviceType">Catégorie</label>
              <select id="deviceType">
                <option value="smartphone">Smartphone</option>
                <option value="laptop">Ordinateur portable</option>
                <option value="tablet">Tablette</option>
              </select>
            </div>
            <div>
              <label for="year">Année (approx. du modèle) *</label>
              <input id="year" type="number" placeholder="Champ requis" />
            </div>
          </div>

          <div class="step"><span class="num">2</span><h2>Marque & modèle</h2></div>
          <div class="row">
            <div>
              <label for="brand">Marque</label>
              <select id="brand"></select>
            </div>
            <div>
              <label for="model">Modèle</label>
              <select id="model"></select>
            </div>
          </div>
          <div class="row">
            <div>
              <label for="otherModel">Autre modèle (si non listé)</label>
              <input id="otherModel" type="text" placeholder="Saisir le modèle exact" />
            </div>
            <div>
              <label for="msrp">Prix neuf d’origine (optionnel, €)</label>
              <input id="msrp" type="number" placeholder="ex: 1299" />
            </div>
          </div>

          <div class="step"><span class="num">3</span><h2>État & mémoire / stockage</h2></div>
          <div class="row">
            <div><label>Écran</label><div class="pillset" data-name="screen"><div class="pill" data-value="ok">Intact</div><div class="pill" data-value="scratched">Rayé</div><div class="pill" data-value="cracked">Fissuré</div></div></div>
            <div><label>Batterie</label><div class="pillset" data-name="battery"><div class="pill" data-value="good">Bonne</div><div class="pill" data-value="weak">Faible</div><div class="pill" data-value="dead">Morte</div></div></div>
          </div>
          <div class="row">
            <div><label>Carte mère</label><div class="pillset" data-name="board"><div class="pill" data-value="clean">Jamais réparée</div><div class="pill" data-value="repaired">Déjà réparée</div><div class="pill" data-value="faulty">HS</div></div></div>
            <div><label>Esthétique</label><div class="pillset" data-name="cosmetics"><div class="pill" data-value="asnew">Comme neuf</div><div class="pill" data-value="used">Usé</div><div class="pill" data-value="bad">Abîmé</div></div></div>
          </div>
          <div class="row">
            <div><label for="storageType">Type de stockage</label><select id="storageType"><option value="auto">Auto</option><option value="hdd">HDD</option><option value="ssd">SSD (SATA)</option><option value="nvme">SSD (NVMe)</option><option value="emmc">eMMC</option></select></div>
            <div><label for="storageSize">Capacité</label><select id="storageSize"><option value="32">32 Go</option><option value="64">64 Go</option><option value="128" selected>128 Go</option><option value="256">256 Go</option><option value="512">512 Go</option><option value="1024">1 To</option><option value="2048">2 To</option></select></div>
          </div>
          <div class="row">
            <div><label>Blocages</label><div class="pillset" data-name="locks"><div class="pill" data-value="none">Aucun</div><div class="pill" data-value="icloud">iCloud/FRP</div><div class="pill" data-value="bios">BIOS/EFI</div></div></div>
            <div><label>Accessoires</label><div class="pillset" data-name="accs"><div class="pill" data-value="box">Boîte</div><div class="pill" data-value="charger">Chargeur</div><div class="pill" data-value="none">Aucun</div></div></div>
          </div>

          <!-- AMÉLIORATION : Section Entretien pour ordinateurs portables -->
          <div id="maintenanceContainer" style="display:none;">
            <div class="step"><span class="num">4</span><h2>Entretien</h2></div>
            <div id="maintenanceSection">
              <label>Un entretien a-t-il déjà été réalisé ?</label>
              <div class="pillset" id="maintenancePillset">
                  <div class="pill" data-maintenance="oui">Oui</div>
                  <div class="pill" data-maintenance="non">Non</div>
              </div>
              <div id="maintenanceDetails" style="display:none; margin-top: 10px;">
                  <div class="row">
                      <div>
                          <label for="maintenanceDate">Date du dernier entretien</label>
                          <input type="date" id="maintenanceDate">
                      </div>
                  </div>
                  <div class="row">
                    <div>
                        <label for="maintenanceType">Type d'entretien réalisé</label>
                        <textarea id="maintenanceType" rows="3" placeholder="ex: Pâte thermique changée, batterie neuve, dépoussiérage..."></textarea>
                    </div>
                  </div>
              </div>
              <div id="maintenanceAdvice" style="display:none;" class="note">
                ⚡ Un entretien régulier est crucial. Nous recommandons un nettoyage complet et un changement de pâte thermique.
                <br>
                <a href="https://wa.me/596696600814?text=Bonjour%20Techprecision,%20j'aimerais%20faire%20un%20entretien/diagnostic%20sur%20ma%20machine." target="_blank" class="btnLink" style="margin-top:12px;">👉 Planifier un entretien via WhatsApp</a>
              </div>
            </div>
          </div>
          
          <div class="note" style="margin-top: 20px;">⚠️ Estimation indicative. Pour affiner, un diagnostic en atelier est recommandé.</div>
        </div>
        <div class="result" id="resultContainer">
          <div class="price"><span id="priceRange">—</span> <small>EUR</small></div>
          <div class="delta" id="deltaText"></div>
          <div class="cta">
            <button class="btn" id="ctaRepair">Maximiser la valeur</button>
            <button class="btn secondary" id="ctaDownload">Télécharger l'estimatif (PDF)</button>
            <button class="btn secondary" id="runTests" title="Lance les auto‑tests">Auto‑tests</button>
          </div>
          <div class="tests" id="testOutput"></div>
        </div>
      </section>

      <aside class="card">
        <div class="body">
          <h2>Comment l’estimation est calculée ?</h2>
          <p class="sub">Méthode transparente et adaptée à la microsoudure.</p>
          <div id="breakdown"></div>
          <hr style="border-color:rgba(255,255,255,.08);margin:18px 0" />
          <h2>Conseils pour augmenter la valeur</h2>
          <ul>
            <li>Remplacement batterie si <span class="tag">faible/morte</span>.</li>
            <li>Upgrade HDD → SSD/NVMe sur laptop (<span class="tag">+10–18%</span>).</li>
            <li>Nettoyage carte mère et reball si oxydation.</li>
          </ul>
        </div>
      </aside>
    </div>

    <footer>© <span id="yearNow"></span> TECHPRECISION972 – Microsoudure & Réparation | Ce simulateur n’est pas un devis contractuel.
      <div class="note">Utilisation: <span id="usageCount">—</span> consultations</div>
    </footer>
  </div>

<!-- AMÉLIORATION : Modale pour "Maximiser la valeur" -->
<div id="repairModal" class="modal-overlay">
  <div class="modal-content">
    <span id="closeModal" class="modal-close">&times;</span>
    <h3>Conseil TECHPRECISION972</h3>
    <p>Un entretien ciblé (batterie, port de charge, nettoyage) peut augmenter la valeur de revente de 10% à 25%.</p>
    <a href="https://wa.me/596696600814?text=Bonjour%20Techprecision,%20j'aimerais%20discuter%20d'une%20r%C3%A9paration%20pour%20maximiser%20la%20valeur%20de%20mon%20appareil." target="_blank" class="btnLink">👉 Contacter l'atelier via WhatsApp</a>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {

  const MIN_YEAR = 2010;
  const CURRENT_YEAR = new Date().getFullYear();
  const CATALOG = {
    smartphone: { Apple: {'iPhone 11': {year:2019, base:300},'iPhone 12': {year:2020, base:380},'iPhone 13': {year:2021, base:470},'iPhone 14': {year:2022, base:560},'iPhone 15': {year:2023, base:640}}, Samsung: {'Galaxy S20': {year:2020, base:300},'Galaxy S21': {year:2021, base:360},'Galaxy S22': {year:2022, base:430},'Galaxy S23': {year:2023, base:520}}, Xiaomi: {'Redmi Note 10': {year:2021, base:120},'Mi 11': {year:2021, base:260}}},
    laptop: { Apple: {'MacBook Air 2019': {year:2019, base:420},'MacBook Pro 2019': {year:2019, base:700},'MacBook Pro 2020': {year:2020, base:850}}, Lenovo: {'ThinkPad T480': {year:2018, base:350},'ThinkPad X1 Carbon (7th)': {year:2019, base:520}}, HP: {'Pavilion 15 2020': {year:2020, base:380}}},
    tablet: { Apple: {'iPad 8': {year:2020, base:220},'iPad Air 4': {year:2020, base:320},'iPad Pro 11 (2021)': {year:2021, base:520}}, Samsung: {'Galaxy Tab S7': {year:2020, base:300}}}
  };
  const DEFAULT_BASE = {smartphone: 220, laptop: 420, tablet: 200};

  const state = {
    deviceType: 'smartphone', brand: null, model: null, year: null, msrp: null,
    condition: {screen:'ok', battery:'good', board:'clean', cosmetics:'asnew'},
    storageType: 'auto', storageSize: 128,
    locks: new Set(['none']), accs: new Set(),
    maintenance: { done: null, date: null, details: '' }
  };

  const byId = id => document.getElementById(id);
  const deviceTypeSel = byId('deviceType'), brandSel = byId('brand'), modelSel = byId('model'),
        yearInput = byId('year'), resultEl = byId('priceRange'), deltaEl = byId('deltaText'),
        breakdownEl = byId('breakdown'), ctaDownloadBtn = byId('ctaDownload'),
        resultContainer = byId('resultContainer'), otherModelInput = byId('otherModel'),
        maintenanceContainer = byId('maintenanceContainer'), maintenancePillset = byId('maintenancePillset'),
        maintenanceDetails = byId('maintenanceDetails'), maintenanceAdvice = byId('maintenanceAdvice'),
        repairModal = byId('repairModal'), closeModal = byId('closeModal');

  function setActive(pillset, value){ [...pillset.querySelectorAll('.pill')].forEach(p => p.dataset.active = (p.dataset.value === value)); }
  function toggleSet(set, value){ if (value === 'none') { set.clear(); set.add('none'); return; } if (set.has('none')) set.delete('none'); set.has(value) ? set.delete(value) : set.add(value); }
  function track(eventName, props){ if(window.plausible){ window.plausible(eventName, {props}); } if(window.gtag){ window.gtag('event', eventName, props || {}); } }

  function populateBrands(){
    const type = deviceTypeSel.value; brandSel.innerHTML = ''; const brands = Object.keys(CATALOG[type] || {});
    if (!brands.length) { brandSel.innerHTML = '<option value="Other">Autre</option>'; populateModels(); return; }
    brands.forEach(b => { const opt = document.createElement('option'); opt.value = b; opt.textContent = b; brandSel.appendChild(opt); });
    const other = document.createElement('option'); other.value = 'Other'; other.textContent = 'Autre'; brandSel.appendChild(other);
    populateModels();
  }

  function populateModels(){
    const type = deviceTypeSel.value, brand = brandSel.value; modelSel.innerHTML = ''; const models = (CATALOG[type] || {})[brand] || {}; const keys = Object.keys(models);
    if (!keys.length) { modelSel.innerHTML = '<option value="Other">Autre</option>'; return; }
    keys.forEach(m => { const opt = document.createElement('option'); opt.value = m; opt.textContent = m; modelSel.appendChild(opt); });
    const other = document.createElement('option'); other.value = 'Other'; other.textContent = 'Autre'; modelSel.appendChild(other);
  }
  
  function toggleMaintenance(){
    const isLaptop = deviceTypeSel.value === 'laptop';
    maintenanceContainer.style.display = isLaptop ? 'block' : 'none';
    if (!isLaptop) {
        state.maintenance = { done: null, date: null, details: '' };
        [...maintenancePillset.querySelectorAll('.pill')].forEach(p => p.dataset.active = 'false');
        maintenanceDetails.style.display = 'none';
        maintenanceAdvice.style.display = 'none';
    }
  }

  function isFormValid() {
    let isValid = true;
    if (!state.year || state.year < MIN_YEAR || state.year > CURRENT_YEAR) { yearInput.classList.add('is-invalid'); isValid = false; } else { yearInput.classList.remove('is-invalid'); }
    if (state.model === 'Other' && !otherModelInput.value.trim()) { otherModelInput.classList.add('is-invalid'); isValid = false; } else { otherModelInput.classList.remove('is-invalid'); }
    return isValid;
  }

  function getBase(){
    const type = state.deviceType; let base = DEFAULT_BASE[type] || 200; let y = state.year;
    const cat = CATALOG[type] || {};
    if (state.brand && state.model && cat[state.brand] && cat[state.brand][state.model]){ base = cat[state.brand][state.model].base; y = y || cat[state.brand][state.model].year; }
    if (state.msrp) { base = Math.max(base, Math.max(80, state.msrp * 0.45)); }
    const age = y ? Math.max(0, CURRENT_YEAR - y) : 3; const curves = {smartphone: .23, laptop: .18, tablet: .2};
    const depFactor = Math.pow((1 - (curves[type] || .2)), age);
    return {agedBase: Math.max(40, base * depFactor), age, y: y || (CURRENT_YEAR - age)};
  }

  function conditionMultiplier(){
    let m = 1; const { screen, battery, board, cosmetics } = state.condition;
    if (screen === 'scratched') m *= 0.93; else if (screen === 'cracked') m *= 0.65;
    if (battery === 'weak') m *= 0.9; else if (battery === 'dead') m *= 0.7;
    if (board === 'repaired') m *= 0.95; else if (board === 'faulty') m *= 0.4;
    if (cosmetics === 'used') m *= 0.95; else if (cosmetics === 'bad') m *= 0.82;
    return m;
  }

  function storageAdj(){
    const type = state.deviceType; let stType = state.storageType;
    if (stType === 'auto') { stType = (type === 'laptop') ? 'ssd' : 'emmc'; }
    const size = state.storageSize; let bonus = 0;
    if (type === 'laptop') { if (stType === 'hdd') bonus -= 40; if (stType === 'ssd') bonus += 60; if (stType === 'nvme') bonus += 90; if (size >= 512) bonus += 40; if (size >= 1024) bonus += 90; if (size >= 2048) bonus += 160;
    } else { if (size >= 256) bonus += 40; if (size >= 512) bonus += 90; if (size >= 1024) bonus += 150; }
    return bonus;
  }

  function locksAdj(){ if (state.locks.has('icloud')) return 0.35; if (state.locks.has('bios')) return 0.6; return 1; }
  function accessoriesAdj(){ let plus = 0; if (state.accs.has('box')) plus += 10; if (state.accs.has('charger')) plus += 15; return plus; }

  function compute(){
    if (!isFormValid()) {
      resultContainer.classList.add('is-disabled'); ctaDownloadBtn.disabled = true;
      resultEl.textContent = '—'; deltaEl.textContent = 'Veuillez remplir tous les champs requis.'; breakdownEl.innerHTML = ''; return;
    }
    resultContainer.classList.remove('is-disabled'); ctaDownloadBtn.disabled = false;
    const baseInfo = getBase(), mCond = conditionMultiplier(), addStorage = storageAdj(), addAccs = accessoriesAdj(), mLocks = locksAdj();
    let mid = Math.max(10, (baseInfo.agedBase * mCond * mLocks) + addStorage + addAccs);
    const uncertainty = (state.condition.board === 'faulty' || state.condition.screen === 'cracked') ? 0.14 : 0.1;
    const lo = Math.max(5, Math.round(mid * (1 - uncertainty) / 5) * 5), hi = Math.max(lo + 5, Math.round(mid * (1 + uncertainty) / 5) * 5);
    resultEl.textContent = `${lo} – ${hi}`; breakdownEl.innerHTML = renderBreakdown({baseInfo, mCond, addStorage, addAccs, mLocks, mid, lo, hi});
    deltaEl.textContent = adviceText(lo, hi); window.__lastEstimate = {lo, hi, mid, baseInfo, mCond, addStorage, addAccs, mLocks};
    if (!window.__firstComputed) { window.__firstComputed = true; track('estimate_calculated', {deviceType: state.deviceType, brand: state.brand||'', model: state.model||''}); }
  }

  function renderBreakdown({baseInfo, mCond, addStorage, addAccs, mLocks, mid, lo, hi}){
    const parts = [`<div class="tag">Base: ~€${Math.round(baseInfo.agedBase)}</div>`, `<div class="tag">État ×${mCond.toFixed(2)}</div>`];
    if(addStorage!==0) parts.push(`<div class="tag">Stockage ${addStorage>0?'+':''}${addStorage}€</div>`); if(addAccs!==0) parts.push(`<div class="tag">Accessoires ${addAccs>0?'+':''}${addAccs}€</div>`); if(mLocks!==1) parts.push(`<div class="tag">Blocages ×${mLocks.toFixed(2)}</div>`);
    return `<p class="muted">Facteurs:</p><div style="margin-bottom:10px">${parts.join(' ')}</div><p class="muted">Médiane: <strong>€${Math.round(mid)}</strong><br/>Plage: <strong>€${lo} – €${hi}</strong></p>`;
  }

  function adviceText(lo, hi){
    const issues = []; if (state.condition.screen === 'cracked') issues.push('écran'); if (state.condition.battery !== 'good') issues.push('batterie'); if (state.condition.board !== 'clean') issues.push('carte mère'); if (state.storageType === 'hdd') issues.push('upgrade SSD');
    if (issues.length === 0) return `Conseil: un nettoyage peut sécuriser la vente (€${hi}).`;
    return `Pour viser le haut de la fourchette, envisagez: ${issues.join(', ')}.`;
  }

  async function getJsPDF(){ if (window.jspdf?.jsPDF) return window.jspdf.jsPDF; throw new Error('jsPDF introuvable.'); }
  async function fetchImageAsDataURL(src){ try { const res = await fetch(src); if (!res.ok) return null; const blob = await res.blob(); return new Promise(resolve => { const r = new FileReader(); r.onload = () => resolve(r.result); r.readAsDataURL(blob); }); } catch(e) { return null; } }
  
  async function generateEstimatePDF(opts = {download: true}){
    let jsPDF; try { jsPDF = await getJsPDF(); } catch(err) { alert("Erreur: " + err.message); throw err; }
    const doc = new jsPDF({unit: 'pt', format: 'a4'});
    const margin = 40;
    let y = margin;
    const pageWidth = doc.internal.pageSize.getWidth();
    const centerX = pageWidth / 2;

    // AMÉLIORATION : En-tête centré avec logo et nom de la marque
    const logoData = await fetchImageAsDataURL('logo.png');
    if (logoData) {
        try {
            const logoWidth = 60;
            const logoHeight = 60;
            doc.addImage(logoData, 'PNG', centerX - (logoWidth / 2), y, logoWidth, logoHeight);
            y += logoHeight + 10;
        } catch(e){ console.error("PDF logo error:", e); }
    }
    doc.setFont('helvetica', 'bold');
    doc.setFontSize(22);
    doc.setTextColor(230, 242, 240); // --text color
    doc.text('TECHPRECISION', centerX, y, { align: 'center' });
    y += 24;
    doc.setFontSize(14);
    doc.setFont('helvetica', 'normal');
    doc.setTextColor(161, 181, 181); // --muted color
    doc.text('Fiche d\'Estimation de Valeur', centerX, y, { align: 'center' });
    y += 16;
    doc.setFontSize(10);
    doc.text(`Émis le ${new Date().toLocaleDateString('fr-FR')}`, centerX, y, { align: 'center' });
    y += 50;
    doc.setTextColor(230, 242, 240); // reset to --text

    const modelText = (state.model === 'Other' ? otherModelInput.value : state.model) || 'N/A';
    const details = {"Catégorie": {smartphone:'Smartphone', laptop:'Ordinateur', tablet:'Tablette'}[state.deviceType], "Marque/Modèle": `${state.brand} ${modelText}`, "Année": state.year || 'N/A', "Stockage": `${byId('storageSize').selectedOptions[0].text} (${byId('storageType').value.toUpperCase()})`};
    doc.setFont('helvetica', 'bold'); doc.setFontSize(12); doc.text("Détails de l'équipement", margin, y); y += 20;
    doc.setFont('helvetica', 'normal'); doc.setFontSize(10);
    for (const [label, value] of Object.entries(details)) { doc.text(`${label}:`, margin, y); doc.text(`${value}`, margin + 150, y); y += 14; }
    y += 14;

    doc.setFont('helvetica', 'bold'); doc.setFontSize(12); doc.text("État déclaré", margin, y); y += 20;
    const conds = {screen: "Écran", battery: "Batterie", board: "Carte mère", cosmetics: "Esthétique"};
    doc.setFont('helvetica', 'normal'); doc.setFontSize(10);
    for (const key in conds) { const pill = document.querySelector(`.pillset[data-name="${key}"] .pill[data-value="${state.condition[key]}"]`); doc.text(`${conds[key]}:`, margin, y); doc.text(pill ? pill.textContent : 'N/A', margin + 150, y); y += 14; }
    
    if (state.deviceType === 'laptop' && state.maintenance.done) {
        y += 14; doc.setFont('helvetica', 'bold'); doc.setFontSize(12); doc.text("Entretien", margin, y); y += 20; doc.setFont('helvetica', 'normal'); doc.setFontSize(10);
        doc.text("Entretien déjà réalisé:", margin, y); doc.text(state.maintenance.done === 'oui' ? 'Oui' : 'Non', margin + 150, y); y+= 14;
        if (state.maintenance.done === 'oui') {
            if(state.maintenance.date) { doc.text("Date:", margin, y); doc.text(new Date(state.maintenance.date).toLocaleDateString('fr-FR'), margin + 150, y); y+= 14; }
            if(state.maintenance.details) { doc.text("Détails:", margin, y); const detailsLines = doc.splitTextToSize(state.maintenance.details, 360); doc.text(detailsLines, margin + 150, y); y += detailsLines.length * 14; }
        }
    }
    y += 20;

    doc.setFont('helvetica', 'bold'); doc.setFontSize(16); doc.setFillColor(240, 240, 240); doc.rect(margin, y - 12, 515, 40, 'F'); doc.setTextColor(10, 13, 18);
    doc.text(`Plage de valeur estimée : ${resultEl.textContent.trim()} EUR`, margin + 10, y + 12);
    y += 50; doc.setTextColor(230, 242, 240);

    doc.setFont('helvetica', 'normal'); doc.setFontSize(9); doc.text("Cet estimatif est indicatif et non contractuel. Une valeur définitive sera confirmée après diagnostic en atelier.", margin, y, { maxWidth: 515 });
    doc.setFontSize(8); doc.setTextColor(161, 181, 181); doc.text(`© ${CURRENT_YEAR} TECHPRECISION`, margin, doc.internal.pageSize.getHeight() - margin);

    if (opts.download) { const safeModel = modelText.replace(/[^a-z0-9]/gi, '_'); doc.save(`estimatif-${state.brand}-${safeModel}.pdf`); }
    return doc;
  }
  
  deviceTypeSel.addEventListener('change', () => { state.deviceType = deviceTypeSel.value; populateBrands(); compute(); toggleMaintenance(); });
  yearInput.addEventListener('input', e => { state.year = parseInt(e.target.value) || null; compute(); });
  byId('msrp').addEventListener('input', e => { state.msrp = parseFloat(e.target.value) || null; compute(); });
  brandSel.addEventListener('change', () => { state.brand = brandSel.value; populateModels(); compute(); });
  modelSel.addEventListener('change', () => { state.model = modelSel.value; compute(); });
  otherModelInput.addEventListener('input', e => { if (modelSel.value === 'Other') { compute(); } });
  byId('storageType').addEventListener('change', e => { state.storageType = e.target.value; compute(); });
  byId('storageSize').addEventListener('change', e => { state.storageSize = parseInt(e.target.value); compute(); });
  
  document.querySelectorAll('.pillset[data-name]').forEach(set => {
    const name = set.dataset.name;
    if (['locks', 'accs'].includes(name)) { set.addEventListener('click', e => { const pill = e.target.closest('.pill'); if (!pill) return; toggleSet(state[name], pill.dataset.value); pill.dataset.active = pill.dataset.active !== "true"; compute(); }); }
    else { setActive(set, {screen: 'ok', battery: 'good', board: 'clean', cosmetics: 'asnew'}[name]); set.addEventListener('click', e => { const pill = e.target.closest('.pill'); if (!pill) return; setActive(set, pill.dataset.value); state.condition[name] = pill.dataset.value; compute(); }); }
  });

  maintenancePillset.addEventListener('click', e => {
    const pill = e.target.closest('.pill'); if (!pill) return; const choice = pill.dataset.maintenance;
    [...maintenancePillset.querySelectorAll('.pill')].forEach(p => p.dataset.active = (p === pill));
    state.maintenance.done = choice;
    maintenanceDetails.style.display = choice === 'oui' ? 'block' : 'none';
    maintenanceAdvice.style.display = choice === 'non' ? 'block' : 'none';
  });
  byId('maintenanceDate').addEventListener('input', e => { state.maintenance.date = e.target.value; });
  byId('maintenanceType').addEventListener('input', e => { state.maintenance.details = e.target.value; });

  byId('ctaRepair').addEventListener('click', () => {
    repairModal.style.display = 'block';
    track('cta_repair_clicked', {deviceType: state.deviceType});
  });

  closeModal.addEventListener('click', () => {
    repairModal.style.display = 'none';
  });
  window.addEventListener('click', e => {
      if (e.target == repairModal) {
          repairModal.style.display = 'none';
      }
  });

  ctaDownloadBtn.addEventListener('click', async () => {
    ctaDownloadBtn.disabled = true; ctaDownloadBtn.textContent = 'Génération...';
    try { await generateEstimatePDF(); track('cta_download_pdf', {deviceType: state.deviceType}); }
    catch(err) { console.error("PDF generation failed:", err); }
    finally { ctaDownloadBtn.disabled = false; ctaDownloadBtn.textContent = 'Télécharger l\'estimatif (PDF)'; }
  });
  
  byId('runTests').addEventListener('click', async () => { /* ... self-tests ... */ });

  function init() {
    yearInput.min = MIN_YEAR; yearInput.max = CURRENT_YEAR;
    byId('yearNow').textContent = CURRENT_YEAR;
    populateBrands(); state.brand = brandSel.value;
    populateModels(); state.model = modelSel.value;
    toggleMaintenance();
    compute();
    fetch('https://api.countapi.xyz/hit/simu-microsoudure/valeur-occasion-total').then(r => r.json()).then(d => { byId('usageCount').textContent = d.value?.toLocaleString('fr-FR') || '1'; }).catch(()=>{});
  }

  init();
});
</script>
</body>
</html>

