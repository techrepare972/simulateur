<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Simulateur de valeur d‚Äôoccasion</title>
  <link rel="icon" type="image/png" href="favicon.png" />
  <style>
    /* Palette adapt√©e au logo (d√©grad√© vert -> bleu clair) */
    :root{
      --bg:#0a0d12;
      --card:#111418ee;
      --muted:#a1b5b5;
      --text:#e6f2f0;
      --accent:#9ae66e; /* vert clair du logo */
      --accent2:#6cd0d9; /* bleu clair du logo */
      --ok:#7ee2a8;
      --bad:#f57c7c;
      --shadow:0 10px 25px rgba(0,0,0,.35);
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:linear-gradient(180deg,#0a0d12,#111418);color:var(--text)}
    .wrap{max-width:1100px;margin:40px auto;padding:20px}
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:24px}
    .brand{display:flex;align-items:center;gap:14px}
    .brand img{width:56px;height:56px;object-fit:contain;border-radius:999px;background:radial-gradient(ellipse at 30% 30%, rgba(154,230,110,.15), rgba(108,208,217,.1));padding:6px;border:1px solid rgba(255,255,255,.06)}
    h1{font-size:clamp(22px,3vw,34px);margin:0;line-height:1.2;background:linear-gradient(90deg,var(--accent),var(--accent2));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
    .badge{font-size:12px;color:#0b1226;background:linear-gradient(90deg,var(--accent),var(--accent2));padding:6px 10px;border-radius:999px;font-weight:700;letter-spacing:.3px}
    .grid{display:grid;grid-template-columns:1.2fr .8fr;gap:20px}
    @media (max-width:960px){.grid{grid-template-columns:1fr}}
    .card{background:var(--card);border:1px solid rgba(255,255,255,.06);border-radius:var(--radius);box-shadow:var(--shadow)}
    .card h2{margin:0 0 6px 0;font-size:18px;color:var(--accent2)}
    .card .sub{color:var(--muted);font-size:13px;margin-bottom:14px}
    .card .body{padding:18px}
    .step{display:flex;gap:12px;align-items:center;margin:16px 0 10px}
    .step .num{width:28px;height:28px;border-radius:999px;display:grid;place-items:center;background:#0b1020;border:1px solid rgba(255,255,255,.08);background:linear-gradient(135deg,var(--accent),var(--accent2));color:#0a0d12;font-weight:700}
    label{display:block;font-size:13px;color:var(--muted);margin:14px 0 6px}
    select,input[type="text"],input[type="number"],.pillset{width:100%;background:#0d1117;border:1px solid rgba(255,255,255,.1);color:var(--text);padding:12px 12px;border-radius:12px;outline:none}
    select:focus,input:focus{border-color:var(--accent2);box-shadow:0 0 0 3px rgba(108,208,217,.2)}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:720px){.row{grid-template-columns:1fr}}
    .pillset{display:flex;gap:8px;flex-wrap:wrap;padding:8px}
    .pill{padding:8px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.1);cursor:pointer;font-size:13px;user-select:none}
    .pill[data-active="true"]{border-color:var(--accent2);box-shadow:0 0 0 2px rgba(108,208,217,.25) inset}
    .result{padding:20px;border-top:1px dashed rgba(255,255,255,.1)}
    .price{font-size:34px;font-weight:800;color:var(--accent)}
    .price small{font-size:14px;color:var(--muted);font-weight:600}
    .delta{color:var(--muted);font-size:13px;margin-top:6px}
    .cta{display:flex;gap:10px;margin-top:16px;flex-wrap:wrap}
    .btn{background:linear-gradient(90deg,var(--accent),var(--accent2));color:#061019;font-weight:800;border:none;border-radius:12px;padding:12px 16px;cursor:pointer}
    .btn:disabled{cursor:not-allowed;opacity:.6}
    .btn.secondary{background:#131a33;color:#e6f2f0;border:1px solid rgba(255,255,255,.08)}
    .tag{display:inline-block;padding:4px 8px;border-radius:999px;background:#0c1328;border:1px solid rgba(255,255,255,.08);font-size:12px;color:var(--muted);margin-right:6px}
    .muted{color:var(--muted)}
    .note{font-size:12px;color:var(--muted);margin-top:8px}
    footer{opacity:.8;text-align:center;font-size:12px;margin:24px 0}
    .maintenanceBox{margin-top:18px;padding:14px;border:1px dashed rgba(255,255,255,.15);border-radius:12px;background:#0c1328}
    .maintenanceBox .question{margin-bottom:8px;font-size:14px;color:var(--text)}
    .maintenanceBox .btnLink{display:inline-block;margin-top:8px;background:linear-gradient(90deg,var(--accent),var(--accent2));color:#061019;padding:8px 12px;border-radius:8px;font-weight:700;text-decoration:none}
    .tests{margin-top:10px;font-size:12px;color:var(--muted)}
  </style>
  <script defer data-domain="techprecision972.com" src="https://plausible.io/js/script.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <img src="logo.png" alt="Logo" />
        <h1>Simulateur de valeur d‚Äôoccasion</h1>
      </div>
      <span class="badge">BETA</span>
    </header>

    <div class="grid">
      <section class="card" id="formCard">
        <div class="body">
          <div class="step"><span class="num">1</span><h2>Type d‚Äô√©quipement</h2></div>
          <div class="row">
            <div>
              <label for="deviceType">Cat√©gorie</label>
              <select id="deviceType">
                <option value="smartphone">Smartphone</option>
                <option value="laptop">Ordinateur portable</option>
                <option value="tablet">Tablette</option>
              </select>
            </div>
            <div>
              <label for="year">Ann√©e (approx. du mod√®le)</label>
              <input id="year" type="number" placeholder="ex: 2021" />
            </div>
          </div>

          <div class="step"><span class="num">2</span><h2>Marque & mod√®le</h2></div>
          <div class="row">
            <div>
              <label for="brand">Marque</label>
              <select id="brand"></select>
            </div>
            <div>
              <label for="model">Mod√®le</label>
              <select id="model"></select>
            </div>
          </div>
          <div class="row">
            <div>
              <label for="otherModel">Autre mod√®le (si non list√©)</label>
              <input id="otherModel" type="text" placeholder="Saisir le mod√®le exact" />
            </div>
            <div>
              <label for="msrp">Prix neuf d‚Äôorigine (optionnel, ‚Ç¨)</label>
              <input id="msrp" type="number" placeholder="ex: 1299" />
            </div>
          </div>

          <div class="step"><span class="num">3</span><h2>√âtat & m√©moire / stockage</h2></div>
          <div class="row">
            <div>
              <label>√âcran</label>
              <div class="pillset" data-name="screen">
                <div class="pill" data-value="ok">Intact</div>
                <div class="pill" data-value="scratched">Ray√©</div>
                <div class="pill" data-value="cracked">Fissur√©</div>
              </div>
            </div>
            <div>
              <label>Batterie</label>
              <div class="pillset" data-name="battery">
                <div class="pill" data-value="good">Bonne autonomie</div>
                <div class="pill" data-value="weak">Faible</div>
                <div class="pill" data-value="dead">Morte</div>
              </div>
            </div>
          </div>
          <div class="row">
            <div>
              <label>Carte m√®re</label>
              <div class="pillset" data-name="board">
                <div class="pill" data-value="clean">Jamais r√©par√©e</div>
                <div class="pill" data-value="repaired">D√©j√† r√©par√©e</div>
                <div class="pill" data-value="faulty">HS</div>
              </div>
            </div>
            <div>
              <label>Esth√©tique</label>
              <div class="pillset" data-name="cosmetics">
                <div class="pill" data-value="asnew">Comme neuf</div>
                <div class="pill" data-value="used">Us√©</div>
                <div class="pill" data-value="bad">Ab√Æm√©</div>
              </div>
            </div>
          </div>

          <div class="row">
            <div>
              <label for="storageType">Type de stockage</label>
              <select id="storageType">
                <option value="auto">Auto (selon appareil)</option>
                <option value="hdd">HDD</option>
                <option value="ssd">SSD (SATA)</option>
                <option value="nvme">SSD (NVMe)</option>
                <option value="emmc">eMMC</option>
              </select>
            </div>
            <div>
              <label for="storageSize">Capacit√©</label>
              <select id="storageSize">
                <option value="32">32 Go</option>
                <option value="64">64 Go</option>
                <option value="128" selected>128 Go</option>
                <option value="256">256 Go</option>
                <option value="512">512 Go</option>
                <option value="1024">1 To</option>
                <option value="2048">2 To</option>
              </select>
            </div>
          </div>

          <div class="row">
            <div>
              <label>Blocages</label>
              <div class="pillset" data-name="locks">
                <div class="pill" data-value="none">Aucun</div>
                <div class="pill" data-value="icloud">iCloud/FRP</div>
                <div class="pill" data-value="bios">BIOS/EFI</div>
              </div>
            </div>
            <div>
              <label>Accessoires</label>
              <div class="pillset" data-name="accs">
                <div class="pill" data-value="box">Bo√Æte</div>
                <div class="pill" data-value="charger">Chargeur</div>
                <div class="pill" data-value="none">Aucun</div>
              </div>
            </div>
          </div>

          <div class="step" id="maintenanceStep" style="display:none"><span class="num">4</span><h2>Maintenance pr√©ventive</h2></div>
          <div class="maintenanceBox" id="maintenanceBox" style="display:none">
            <div class="question">Avez-vous d√©j√† r√©alis√© des t√¢ches de maintenance mat√©riel (nettoyage interne, d√©poussi√©rage, changement p√¢te thermique, etc.) ?</div>
            <div>
              <label><input type="radio" name="maintenance" value="oui"> Oui</label>
              <label style="margin-left:12px"><input type="radio" name="maintenance" value="non"> Non</label>
            </div>
            <div id="maintenanceAdvice" class="note"></div>
          </div>

          <div class="note">‚ö†Ô∏è Estimation indicative bas√©e sur l‚Äô√©tat et le march√© de l‚Äôoccasion. Pour affiner, un diagnostic en atelier est recommand√©.</div>
        </div>
        <div class="result" id="result">
          <div class="price"><span id="priceRange">‚Äî</span> <small>EUR</small></div>
          <div class="delta" id="deltaText">Compl√©tez les champs pour obtenir une estimation.</div>
          <div class="cta">
            <button class="btn" id="ctaRepair">Maximiser la valeur (proposition de r√©paration)</button>
            <button class="btn secondary" id="ctaDownload">T√©l√©charger l'estimatif (PDF)</button>
            <button class="btn secondary" id="runTests" title="Lance les auto‚Äëtests">Auto‚Äëtests</button>
          </div>
          <div class="tests" id="testOutput"></div>
        </div>
      </section>

      <aside class="card">
        <div class="body">
          <h2>Comment l‚Äôestimation est calcul√©e ?</h2>
          <p class="sub">M√©thode transparente et adapt√©e √† la microsoudure.</p>
          <div id="breakdown"></div>
          <hr style="border-color:rgba(255,255,255,.08);margin:18px 0" />
          <h2>Conseils pour augmenter la valeur</h2>
          <ul>
            <li>Remplacement batterie si <span class="tag">faible/morte</span>.</li>
            <li>R√©parer port de charge / lignes d‚Äôalimentation (<span class="tag">microsoudure</span>).</li>
            <li>Upgrade HDD ‚Üí SSD/NVMe sur laptop (<span class="tag">+10‚Äì18%</span> en moyenne).</li>
            <li>Nettoyage carte m√®re et reball si oxydation.</li>
          </ul>
          <p class="note">Astuce: proposez au client un <strong>pack ‚Äúpr√©-vente‚Äù</strong> (batterie + nettoyage + contr√¥le) pour maximiser le prix final.</p>
        </div>
      </aside>
    </div>

    <footer>¬© <span id="yearNow"></span> Votre Atelier ‚Äì Microsoudure & R√©paration | Ce simulateur n‚Äôest pas un devis contractuel.
      <div class="note">Utilisation: <span id="usageCount">‚Äî</span> consultations</div>
    </footer>
  </div>

<script>
document.addEventListener('DOMContentLoaded', () => {

  // --- Constantes et Configuration ---
  const MIN_YEAR = 2010;
  const CURRENT_YEAR = new Date().getFullYear();
  const CATALOG = {
    smartphone: {
      Apple: {
        'iPhone 11': {year:2019, base:300}, 'iPhone 12': {year:2020, base:380}, 'iPhone 13': {year:2021, base:470},
        'iPhone 14': {year:2022, base:560}, 'iPhone 15': {year:2023, base:640},
      },
      Samsung: {
        'Galaxy S20': {year:2020, base:300}, 'Galaxy S21': {year:2021, base:360}, 'Galaxy S22': {year:2022, base:430}, 'Galaxy S23': {year:2023, base:520},
      },
      Xiaomi: { 'Redmi Note 10': {year:2021, base:120}, 'Mi 11': {year:2021, base:260} }
    },
    laptop: {
      Apple: { 'MacBook Air 2019': {year:2019, base:420}, 'MacBook Pro 2019': {year:2019, base:700}, 'MacBook Pro 2020': {year:2020, base:850}, },
      Lenovo: { 'ThinkPad T480': {year:2018, base:350}, 'ThinkPad X1 Carbon (7th)': {year:2019, base:520}, },
      HP: { 'Pavilion 15 2020': {year:2020, base:380} }
    },
    tablet: {
      Apple: { 'iPad 8': {year:2020, base:220}, 'iPad Air 4': {year:2020, base:320}, 'iPad Pro 11 (2021)': {year:2021, base:520}, },
      Samsung: { 'Galaxy Tab S7': {year:2020, base:300} }
    }
  };
  const DEFAULT_BASE = {smartphone: 220, laptop: 420, tablet: 200};

  // --- √âtat de l'application ---
  const state = {
    deviceType: 'smartphone', brand: null, model: null, year: null, msrp: null,
    condition: {screen:'ok', battery:'good', board:'clean', cosmetics:'asnew'},
    storageType: 'auto', storageSize: 128,
    locks: new Set(['none']), accs: new Set(),
  };

  // --- Helpers & Utilitaires ---
  const byId = id => document.getElementById(id);
  function setActive(pillset, value){
    [...pillset.querySelectorAll('.pill')].forEach(p => p.dataset.active = (p.dataset.value === value));
  }
  function toggleSet(set, value){
    if (value === 'none') { set.clear(); set.add('none'); return; }
    if (set.has('none')) set.delete('none');
    set.has(value) ? set.delete(value) : set.add(value);
  }
  function track(eventName, props){
    if(window.plausible){ window.plausible(eventName, {props}); }
    if(window.gtag){ window.gtag('event', eventName, props || {}); }
  }

  // --- √âl√©ments du DOM ---
  const deviceTypeSel = byId('deviceType');
  const brandSel = byId('brand');
  const modelSel = byId('model');
  const yearInput = byId('year');
  const resultEl = byId('priceRange');
  const deltaEl = byId('deltaText');
  const breakdownEl = byId('breakdown');
  const ctaDownloadBtn = byId('ctaDownload');

  // --- Logique UI ---
  function populateBrands(){
    const type = deviceTypeSel.value;
    brandSel.innerHTML = '';
    const brands = Object.keys(CATALOG[type] || {});
    if (!brands.length) { brandSel.innerHTML = '<option value="Other">Autre</option>'; populateModels(); return; }
    brands.forEach(b => {
      const opt = document.createElement('option');
      opt.value = b; opt.textContent = b;
      brandSel.appendChild(opt);
    });
    const other = document.createElement('option');
    other.value = 'Other'; other.textContent = 'Autre';
    brandSel.appendChild(other);
    populateModels();
  }

  function populateModels(){
    const type = deviceTypeSel.value;
    const brand = brandSel.value;
    modelSel.innerHTML = '';
    const models = (CATALOG[type] || {})[brand] || {};
    const keys = Object.keys(models);
    if (!keys.length) { modelSel.innerHTML = '<option value="Other">Autre</option>'; return; }
    keys.forEach(m => {
      const opt = document.createElement('option');
      opt.value = m; opt.textContent = m;
      modelSel.appendChild(opt);
    });
    const other = document.createElement('option');
    other.value = 'Other'; other.textContent = 'Autre';
    modelSel.appendChild(other);
  }
  
  function toggleMaintenance(){
    const display = deviceTypeSel.value === 'laptop' ? 'flex' : 'none';
    byId('maintenanceStep').style.display = display;
    byId('maintenanceBox').style.display = (display === 'flex' ? 'block' : 'none');
  }

  // --- Moteur de calcul ---
  function getBase(){
    const type = state.deviceType;
    let base = DEFAULT_BASE[type] || 200;
    let y = state.year || null;

    const cat = CATALOG[type] || {};
    if (state.brand && state.model && cat[state.brand] && cat[state.brand][state.model]){
      base = cat[state.brand][state.model].base;
      y = y || cat[state.brand][state.model].year;
    }
    if (state.msrp) {
      base = Math.max(base, Math.max(80, state.msrp * 0.45));
    }
    
    const age = y ? Math.max(0, CURRENT_YEAR - y) : 3;
    const curves = {smartphone: .23, laptop: .18, tablet: .2};
    const depFactor = Math.pow((1 - (curves[type] || .2)), age);
    const agedBase = Math.max(40, base * depFactor);
    return {agedBase, age, y: y || (CURRENT_YEAR - age)};
  }

  function conditionMultiplier(){
    let m = 1;
    const { screen, battery, board, cosmetics } = state.condition;
    if (screen === 'scratched') m *= 0.93; else if (screen === 'cracked') m *= 0.65;
    if (battery === 'weak') m *= 0.9; else if (battery === 'dead') m *= 0.7;
    if (board === 'repaired') m *= 0.95; else if (board === 'faulty') m *= 0.4;
    if (cosmetics === 'used') m *= 0.95; else if (cosmetics === 'bad') m *= 0.82;
    return m;
  }

  function storageAdj(){
    const type = state.deviceType;
    let stType = state.storageType;
    if (stType === 'auto') {
      stType = (type === 'laptop') ? 'ssd' : 'emmc';
    }
    const size = state.storageSize;
    let bonus = 0;
    if (type === 'laptop') {
      if (stType === 'hdd') bonus -= 40;
      if (stType === 'ssd') bonus += 60;
      if (stType === 'nvme') bonus += 90;
      if (size >= 512) bonus += 40;
      if (size >= 1024) bonus += 90;
      if (size >= 2048) bonus += 160;
    } else {
      if (size >= 256) bonus += 40;
      if (size >= 512) bonus += 90;
      if (size >= 1024) bonus += 150;
    }
    return bonus;
  }

  function locksAdj(){
    if (state.locks.has('icloud')) return 0.35;
    if (state.locks.has('bios')) return 0.6;
    return 1;
  }

  function accessoriesAdj(){
    let plus = 0;
    if (state.accs.has('box')) plus += 10;
    if (state.accs.has('charger')) plus += 15;
    return plus;
  }

  function compute(){
    const baseInfo = getBase();
    const mCond = conditionMultiplier();
    const addStorage = storageAdj();
    const addAccs = accessoriesAdj();
    const mLocks = locksAdj();

    let mid = Math.max(10, (baseInfo.agedBase * mCond * mLocks) + addStorage + addAccs);
    const uncertainty = (state.condition.board === 'faulty' || state.condition.screen === 'cracked') ? 0.14 : 0.1;
    const lo = Math.max(5, Math.round(mid * (1 - uncertainty) / 5) * 5);
    const hi = Math.max(lo + 5, Math.round(mid * (1 + uncertainty) / 5) * 5);

    resultEl.textContent = `${lo} ‚Äì ${hi}`;
    breakdownEl.innerHTML = renderBreakdown({baseInfo, mCond, addStorage, addAccs, mLocks, mid, lo, hi});
    deltaEl.textContent = adviceText(lo, hi);
    window.__lastEstimate = {lo, hi, mid, baseInfo, mCond, addStorage, addAccs, mLocks};

    if (!window.__firstComputed) {
      window.__firstComputed = true;
      track('estimate_calculated', {deviceType: state.deviceType, brand: state.brand||'', model: state.model||''});
    }
  }

  function renderBreakdown({baseInfo, mCond, addStorage, addAccs, mLocks, mid, lo, hi}){
    const parts = [
        `<div class="tag">Base (apr√®s √¢ge): ~‚Ç¨${Math.round(baseInfo.agedBase)}</div>`,
        `<div class="tag">√âtat √ó${mCond.toFixed(2)}</div>`
    ];
    if(addStorage!==0) parts.push(`<div class="tag">Stockage ${addStorage>0?'+':''}${addStorage}‚Ç¨</div>`);
    if(addAccs!==0) parts.push(`<div class="tag">Accessoires ${addAccs>0?'+':''}${addAccs}‚Ç¨</div>`);
    if(mLocks!==1) parts.push(`<div class="tag">Blocages √ó${mLocks.toFixed(2)}</div>`);
    
    return `
      <p class="muted">R√©sum√© des facteurs :</p>
      <div style="margin-bottom:10px">${parts.join(' ')}</div>
      <p class="muted">Estimation m√©diane: <strong>‚Ç¨${Math.round(mid)}</strong><br/>Plage propos√©e: <strong>‚Ç¨${lo} ‚Äì ‚Ç¨${hi}</strong></p>
      <p class="note">Transparence: utilisez cette d√©composition pour justifier vos offres.</p>`;
  }

  function adviceText(lo, hi){
    const issues = [];
    if (state.condition.screen === 'cracked') issues.push('remplacement √©cran');
    if (state.condition.battery !== 'good') issues.push('remplacement batterie');
    if (state.condition.board !== 'clean') issues.push('diagnostic carte m√®re');
    if (state.storageType === 'hdd') issues.push('upgrade SSD');
    if (issues.length === 0) return `Conseil: un contr√¥le + nettoyage peut s√©curiser la vente et maintenir la valeur dans le haut de la fourchette (‚Ç¨${hi}).`;
    return `Pour viser le haut de la fourchette, envisagez: ${issues.join(', ')}.`;
  }

  // --- Gestion PDF ---
  async function getJsPDF(){
    if (window.jspdf?.jsPDF) return window.jspdf.jsPDF;
    // Tente de charger via des CDNs alternatifs si le premier a √©chou√©
    const fallbacks = [
      'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js',
      'https://unpkg.com/jspdf@2.5.1/dist/jspdf.umd.min.js'
    ];
    for (const url of fallbacks) {
      try {
        await new Promise((resolve, reject) => {
          const s = document.createElement('script'); s.src = url; s.async = true;
          s.onload = resolve; s.onerror = reject; document.head.appendChild(s);
        });
        if (window.jspdf?.jsPDF) return window.jspdf.jsPDF;
      } catch (e) { console.warn(`Failed to load jsPDF from ${url}`); }
    }
    throw new Error('jsPDF introuvable. Le chargement a √©chou√© depuis tous les CDNs.');
  }

  async function fetchImageAsDataURL(src){
    try {
      const res = await fetch(src);
      if (!res.ok) return null;
      const blob = await res.blob();
      return new Promise(resolve => { const r = new FileReader(); r.onload = () => resolve(r.result); r.readAsDataURL(blob); });
    } catch(e) { return null; }
  }
  
  // AM√âLIORATION : Fonction de g√©n√©ration PDF plus compl√®te et robuste
  async function generateEstimatePDF(opts = {download: true}){
    let jsPDF;
    try {
      jsPDF = await getJsPDF();
    } catch(err) {
      alert("Erreur: Impossible de charger le module PDF. Vous pouvez utiliser Fichier ‚Üí Imprimer ‚Üí Enregistrer en PDF.\nD√©tail: " + err.message);
      throw err;
    }

    const doc = new jsPDF({unit: 'pt', format: 'a4'});
    const margin = 40; let y = margin;
    const FONT_SIZE = 10;
    const LINE_HEIGHT = 14;

    // --- En-t√™te ---
    const logoData = await fetchImageAsDataURL('logo.png');
    if (logoData) { try { doc.addImage(logoData, 'PNG', margin, y, 48, 48); } catch(e){} }
    doc.setFont('helvetica', 'bold'); doc.setFontSize(18);
    doc.text('Fiche d\'Estimation de Valeur', margin + 60, y + 24);
    doc.setFont('helvetica', 'normal'); doc.setFontSize(FONT_SIZE);
    doc.text(new Date().toLocaleString('fr-FR', {dateStyle: 'long', timeStyle: 'short'}), margin + 60, y + 40);
    y += 80;

    // --- D√©tails de l'√©quipement ---
    const typeLabel = {smartphone:'Smartphone', laptop:'Ordinateur portable', tablet:'Tablette'}[state.deviceType] || 'N/A';
    const brand = state.brand || 'N/A';
    const model = (state.model === 'Other' ? byId('otherModel').value : state.model) || 'N/A';
    const modelText = model === 'N/A' ? 'Non sp√©cifi√©' : `${brand} ${model}`;

    doc.setFont('helvetica', 'bold'); doc.setFontSize(12);
    doc.text("D√©tails de l'√©quipement", margin, y); y += LINE_HEIGHT * 1.5;
    
    const details = {
      "Cat√©gorie": typeLabel,
      "Marque / Mod√®le": modelText,
      "Ann√©e du mod√®le": state.year || 'Non sp√©cifi√©e',
      "Capacit√© de stockage": `${byId('storageSize').selectedOptions[0].text} (${byId('storageType').value.toUpperCase()})`
    };

    doc.setFont('helvetica', 'normal'); doc.setFontSize(FONT_SIZE);
    for (const [label, value] of Object.entries(details)) {
      doc.text(`${label}:`, margin, y);
      doc.text(`${value}`, margin + 150, y);
      y += LINE_HEIGHT;
    }
    y += LINE_HEIGHT;
    
    // --- √âtat d√©clar√© ---
    doc.setFont('helvetica', 'bold'); doc.setFontSize(12);
    doc.text("√âtat d√©clar√© de l'appareil", margin, y); y += LINE_HEIGHT * 1.5;

    const conditionLabels = {
        screen: {label: "√âcran", values: {ok: "Intact", scratched: "Ray√©", cracked: "Fissur√©"}},
        battery: {label: "Batterie", values: {good: "Bonne", weak: "Faible", dead: "Morte"}},
        board: {label: "Carte m√®re", values: {clean: "Jamais r√©par√©e", repaired: "D√©j√† r√©par√©e", faulty: "HS"}},
        cosmetics: {label: "Esth√©tique", values: {asnew: "Comme neuf", used: "Us√©", bad: "Ab√Æm√©"}}
    };
    
    doc.setFont('helvetica', 'normal'); doc.setFontSize(FONT_SIZE);
    for (const [key, config] of Object.entries(conditionLabels)) {
        const value = state.condition[key];
        doc.text(`${config.label}:`, margin, y);
        doc.text(config.values[value] || 'N/A', margin + 150, y);
        y += LINE_HEIGHT;
    }
    y += LINE_HEIGHT;

    // --- Estimation ---
    doc.setFont('helvetica', 'bold'); doc.setFontSize(16);
    doc.setFillColor(240, 240, 240); // Gris clair
    doc.rect(margin, y - 12, 515, 40, 'F');
    doc.setTextColor(10, 13, 18); // --bg
    doc.text(`Plage de valeur estim√©e : ${resultEl.textContent.trim()} EUR`, margin + 10, y + 12);
    y += 50;
    doc.setTextColor(230, 242, 240); // --text

    // --- Notes ---
    doc.setFont('helvetica', 'normal'); doc.setFontSize(9);
    doc.text(
      "Cet estimatif est indicatif et non contractuel. Il est bas√© sur les informations fournies et le march√© actuel de l'occasion.\nUne valeur d√©finitive ne peut √™tre confirm√©e qu'apr√®s un diagnostic complet en atelier.",
      margin, y, { maxWidth: 515 }
    );
    
    // --- Pied de page ---
    doc.setFontSize(8); doc.setTextColor(161, 181, 181); // --muted
    const pageHeight = doc.internal.pageSize.getHeight();
    doc.text(`¬© ${CURRENT_YEAR} Votre Atelier ‚Äì Microsoudure & R√©paration`, margin, pageHeight - margin);

    if (opts.download) {
      const safeModel = model.replace(/[^a-z0-9]/gi, '_').replace(/_+/g, '_');
      const filename = `estimatif-${brand}-${safeModel}.pdf`;
      doc.save(filename);
    }
    return doc;
  }
  
  // --- √âcouteurs d'√©v√©nements ---
  deviceTypeSel.addEventListener('change', () => { state.deviceType = deviceTypeSel.value; populateBrands(); compute(); toggleMaintenance(); });
  yearInput.addEventListener('input', e => { state.year = parseInt(e.target.value) || null; compute(); });
  byId('msrp').addEventListener('input', e => { state.msrp = parseFloat(e.target.value) || null; compute(); });
  brandSel.addEventListener('change', () => { state.brand = brandSel.value; populateModels(); compute(); });
  modelSel.addEventListener('change', () => { state.model = modelSel.value; compute(); });
  byId('otherModel').addEventListener('input', e => { if (modelSel.value === 'Other') { state.model = e.target.value.trim(); compute(); } });
  byId('storageType').addEventListener('change', e => { state.storageType = e.target.value; compute(); });
  byId('storageSize').addEventListener('change', e => { state.storageSize = parseInt(e.target.value); compute(); });
  
  document.querySelectorAll('.pillset').forEach(set => {
    const name = set.dataset.name;
    if (['locks', 'accs'].includes(name)) {
      set.addEventListener('click', e => {
        const pill = e.target.closest('.pill'); if (!pill) return;
        toggleSet(state[name], pill.dataset.value);
        pill.dataset.active = pill.dataset.active !== "true"; // Simple toggle for visual
        compute();
      });
    } else { // single-choice
      const def = {screen: 'ok', battery: 'good', board: 'clean', cosmetics: 'asnew'}[name];
      setActive(set, def);
      set.addEventListener('click', e => {
        const pill = e.target.closest('.pill'); if (!pill) return;
        setActive(set, pill.dataset.value);
        state.condition[name] = pill.dataset.value;
        compute();
      });
    }
  });

  byId('ctaRepair').addEventListener('click', () => {
    alert('Conseil: Batterie + port de charge + nettoyage = +10‚Äì25% sur la valeur. Contactez l‚Äôatelier pour un devis.');
    track('cta_repair_clicked', {deviceType: state.deviceType});
  });

  ctaDownloadBtn.addEventListener('click', async () => {
    ctaDownloadBtn.disabled = true;
    ctaDownloadBtn.textContent = 'G√©n√©ration en cours...';
    try {
      await generateEstimatePDF();
      track('cta_download_pdf', {deviceType: state.deviceType});
    } catch(err) {
      console.error("PDF generation failed:", err);
    } finally {
      ctaDownloadBtn.disabled = false;
      ctaDownloadBtn.textContent = 'T√©l√©charger l\'estimatif (PDF)';
    }
  });

  document.querySelectorAll('input[name="maintenance"]').forEach(r => {
    r.addEventListener('change', e => {
      const advice = byId('maintenanceAdvice');
      if (e.target.value === 'non') {
        advice.innerHTML = "‚ö° Nous recommandons vivement un entretien mat√©riel complet (nettoyage, p√¢te thermique). C‚Äôest un gage de qualit√© ! <br><a href='https://wa.me/596696600814?text=Bonjour%2C%20je%20souhaite%20faire%20une%20tache%20de%20maintenance%20pour%20mon%20%C3%A9quipement.' target='_blank' class='btnLink'>üëâ Planifier via WhatsApp</a>";
      } else {
        advice.innerHTML = "üëç Parfait ! Votre appareil a √©t√© suivi, c'est un excellent point pour la revente.";
      }
    });
  });
  
  // --- Auto-tests ---
  async function runSelfTests(){
      const out=[];
      try { const J = await getJsPDF(); out.push(['Charge jsPDF', !!J]); }
      catch(e){ out.push(['Charge jsPDF', false, e.message]); }
      
      const prev = JSON.parse(JSON.stringify(state));
      const prevType = deviceTypeSel.value; const prevBrand = brandSel.value; const prevModel = modelSel.value;

      deviceTypeSel.value='laptop'; state.deviceType='laptop'; populateBrands(); brandSel.value='Apple'; state.brand='Apple'; populateModels(); modelSel.value='MacBook Pro 2020'; state.model='MacBook Pro 2020';
      yearInput.value = '2020'; state.year=2020; compute();
      const rangeText = resultEl.textContent; const ok = /\d+\s‚Äì\s\d+/.test(rangeText);
      out.push(['Estimation affiche une plage', ok, rangeText]);
      
      try { const doc = await generateEstimatePDF({download:false}); out.push(['G√©n√©ration PDF (dry-run)', !!doc]); }
      catch(e){ out.push(['G√©n√©ration PDF (dry-run)', false, e.message]); }
      
      deviceTypeSel.value=prevType; state.deviceType=prev.deviceType; populateBrands(); brandSel.value=prevBrand; state.brand=prev.brand; populateModels(); modelSel.value=prevModel; state.model=prev.model;
      yearInput.value = prev.year||''; state.year=prev.year;
      compute(); toggleMaintenance();

      byId('testOutput').innerHTML = out.map(([name, pass, extra])=>`<div>${pass?'‚úÖ':'‚ùå'} ${name}${extra?` ‚Äî <span class='muted'>${extra}</span>`:''}</div>`).join('');
  }
  byId('runTests').addEventListener('click', runSelfTests);

  // --- Initialisation de la page ---
  function init() {
    // AM√âLIORATION : D√©finit la plage d'ann√©es dynamiquement
    yearInput.min = MIN_YEAR;
    yearInput.max = CURRENT_YEAR;
    yearInput.placeholder = `ex: ${CURRENT_YEAR - 2}`;
    
    byId('yearNow').textContent = CURRENT_YEAR;
    
    populateBrands();
    state.brand = brandSel.value;
    populateModels();
    state.model = modelSel.value;
    toggleMaintenance();
    compute();

    // Compteur de consultations
    fetch('https://api.countapi.xyz/hit/simu-microsoudure/valeur-occasion-total')
      .then(r => r.json()).then(d => { byId('usageCount').textContent = d.value?.toLocaleString('fr-FR') || '1'; })
      .catch(console.warn);
  }

  init();

});
</script>
</body>
</html>
